<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Runtime + Sync = ðŸš€!</title>
    <style>
      body {
        font-family: -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI',
          Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: #0d122b;
        border-top: 5px solid #f22f46;
      }
      main {
        max-width: 800px;
        margin: 0 auto;
      }
      a {
        color: #008cff;
      }
      footer {
        margin: 0 auto;
        max-width: 800px;
        text-align: center;
      }
      footer p {
        border-top: 1px solid rgba(148, 151, 155, 0.2);
        padding-top: 2em;
        margin: 0 2em;
      }

      .container {
      width: 80%;
      margin: 20px auto;
      display: flex;
      justify-content: space-between;
    }

    table {
      width: 48%; /* Adjust as needed to leave some space between the tables */
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #3498db; /* Blue heading */
      color: #fff; /* White text for heading */
    }

    tr:hover {
      background-color: #f5f5f5;
    }

    </style>
  </head>
  <body>
    <main>
      
        <div class="container">
            <table>
              <thead>
                <tr>
                  <th>Action Items</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                    <td><ul id="tasks-list" /></td>
                </tr>

              </tbody>
            </table>
          
            <table>
              <thead>
                <tr>
                  <th>Conversation</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><ul id="convo-list" /></td>
                </tr>
              
                <!-- Add more rows as needed -->
              </tbody>
            </table>
          </div>
    
    
    </main>

    <footer>
      <p>
        Powered by Twilio
      </p>
    </footer>
  </body>
  <script
    type="text/javascript"
    src="//media.twiliocdn.com/sdk/js/sync/v3.0/twilio-sync.min.js"
  ></script>
  <script>
    window.addEventListener('load', async () => {
      const convoList = document.getElementById('convo-list');
      const tasksList = document.getElementById('tasks-list');
      //const loadingMessage = document.getElementById('loading-message');
        
      try {
        // Get the Sync access token and list name from the serverless function
        /*const { syncListName, token } = await fetch('/access').then(async (res) =>
        {
            var body =  await res.json();
            console.log(body);

            res.json()
        }
        );*/
        const response = await fetch('/access');
        const responseJSON = await response.json();
        convoSyncListName = responseJSON.convoSyncListName;
        tasksSyncListName = responseJSON.taskSyncListName;
        token = responseJSON.token;

        const syncClient = new Twilio.Sync.Client(token);
        const convoSyncList = await syncClient.list(convoSyncListName);
        const tasksSyncList = await syncClient.list(tasksSyncListName);

        // Get the most recent messages (if any) in the List
        const existingConvoItems = await convoSyncList.getItems({ order: 'desc' });
        const existingTasksItems = await tasksSyncList.getItems({ order: 'desc' });

        // Hide the loading message
        //loadingMessage.style.display = 'none';
        // Render any existing messages to the page, remember to reverse the order
        // since they're fetched in descending order in this case
        convoList.innerHTML = existingConvoItems.items
          .reverse()
          .map((item) => `<li><b>${item.data.user} :</b> ${item.data.content}</li>`)
          .join('');
        // Add an event listener to the List so that incoming messages can
        // be displayed in real-time
        convoSyncList.on('itemAdded', ({ item }) => {
          console.log('Item added:', item);
          // Add the new message to the list by adding a new <li> element
          // containing the incoming message's text
          const newListItem = document.createElement('li');
          convoList.appendChild(newListItem).innerHTML = `<li><b>${item.data.user} :</b> ${item.data.content}</li>`;
        });

        tasksList.innerHTML = existingTasksItems.items
          .reverse()
          .map((item) => `<input type="checkbox">  ${item.data.order} <br>`)
          .join('');
        // Add an event listener to the List so that incoming messages can
        // be displayed in real-time
        tasksSyncList.on('itemAdded', ({ item }) => {
          console.log('Task Item added:', item);
          // Add the new message to the list by adding a new <li> element
          // containing the incoming message's text
          //const newListItem = document.createElement('<input type="checkbox">');
          tasksList.innerHTML += `<input type="checkbox"> ${item.data.order} <br>`;
        });

        // Make sure to refresh the access token before it expires for an uninterrupted experience! 
        
        syncClient.on('tokenAboutToExpire', async () => {
          try {
            // Refresh the access token and update the Sync client
            //TODO: fix this. never tested it
            const refreshAccess = await fetch('/access').then((res) =>
              res.json()
            );
            syncClient.updateToken(refreshAccess.token);
          } catch (error) {
            console.error(error);
            /*loadingMessage.innerText =
              'Unable to refresh access to messages ðŸ˜­, try reloading your page!';
            loadingMessage.style.color = 'red';
            loadingMessage.style.fontWeight = 'bold';*/
          }
        });
      } catch (error) {
        console.error(error);
        /*loadingMessage.innerText = 'Unable to load messages ðŸ˜­';
        loadingMessage.style.color = 'red';
        loadingMessage.style.fontWeight = 'bold';*/
      }
    });
  </script>
</html>
